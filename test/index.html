<!DOCTYPE html>
<html>
<head>
  <title>XSLT Polyfill Test Runner</title>
<style>
  body {
    font-family: sans-serif;
  }
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 4px;
    text-align: left;
  }
  th {
    background-color: #f2f2f2;
  }
  iframe {
    height: 3em;
    width: 100%;
    border: 0;
  }
</style>
</head>
<body>
  <h1>XSLT Polyfill Test Runner</h1>
  <div>
    <select id="mode">
      <option value="native">Run with Native Browser Feature</option>
      <option value="src">Run with Polyfill (Source)</option>
      <option value="min">Run with Polyfill (Minified)</option>
    </select>
    <button id="go">Go</button>
  </div>
  <table id="results">
    <thead>
      <tr>
        <th>Test Case</th>
        <th>Output</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</body>
</html>

<script>
  function addTestResult(name, iframe) {
    const row = document.createElement('tr');
    const nameCell = document.createElement('td');
    nameCell.textContent = name;
    row.appendChild(nameCell);
    const outputCell = document.createElement('td');
    outputCell.appendChild(iframe);
    row.appendChild(outputCell);
    document.getElementById('results').querySelector('tbody').appendChild(row);
  }
  function assert(cond,msg) {
    msg = msg || "Error";
    if (!cond) {
      document.documentElement.innerHTML = msg;
      throw new Error(msg);
    }
  }

  function runTest(testCase, mode) {
    const iframe = document.createElement('iframe');

    let content = '';
    if (testCase.html) {
      content = testCase.html;
    } else { // XML case
      let xml = testCase.xml;
      if (testCase.xsl) {
        const xsl_base64 = btoa(unescape(encodeURIComponent(testCase.xsl)));
        xml = xml.replace('{{XSL_HREF}}', `data:application/xml;charset=utf-8;base64,${xsl_base64}`);
      }
      content = xml;
    }

    let scriptInjection = '';
    if (mode === 'src') {
      scriptInjection =
          '<script src="../dist/xslt_wasm.js" xmlns="http://www.w3.org/1999/xhtml" charset="utf-8"><\/script>' +
          '<script src="../src/xslt-polyfill-src.js" xmlns="http://www.w3.org/1999/xhtml"><\/script>';
    } else if (mode === 'min') {
      scriptInjection =
          '<script src="../xslt-polyfill.min.js" xmlns="http://www.w3.org/1999/xhtml" charset="utf-8"><\/script>';
    } else {
      assert(mode === 'native');
    }
    content = content.replace('{{SCRIPT_INJECTION_LOCATION}}', scriptInjection);

    // For polyfill cases, we need to tell the polyfill to transform the doc.
    if (mode !== 'native') {
      iframe.addEventListener('load', () => replaceCurrentXMLDoc(iframe.contentDocument));
    }

    iframe.srcdoc = content;
    return iframe;
  }

  let nativeSupported = ('XSLTProcessor' in window) && window.XSLTProcessor.toString().includes('native code');
  if (nativeSupported) {
    try {
      new XSLTProcessor();
    } catch {
      nativeSupported = false;
    }
  }
  const modeElement = document.getElementById('mode')
  function runTests() {
    document.getElementById('results').querySelector('tbody').innerHTML = '';
    const mode = modeElement.value;
    if (mode === 'native' && !nativeSupported) {
      alert('Native XSLTProcessor not supported by this browser.');
      return;
    }
    for (const testCase of testCases) {
      const iframe = runTest(testCase, mode);
      addTestResult(testCase.name, iframe);
    }
  }

  if (nativeSupported) {
    modeElement.options[1].disabled = true;
    modeElement.options[2].disabled = true;
  } else {
    modeElement.options[0].disabled = true;
    modeElement.selectedIndex = 1;
  }
  document.getElementById('go').addEventListener('click', runTests);
</script>
